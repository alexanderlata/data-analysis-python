# Pandas: Справочник

## 1. Общее представление о Pandas

**История**: создана Уэсом МакКинни в 2008 году для работы с финансовыми данными. Название от "panel data".

**Ключевые особенности**: высокая производительность, интуитивный API, встроенные инструменты для обработки данных, интеграция с NumPy/Matplotlib/scikit-learn, работа с временными рядами.

**Области применения**: анализ данных (EDA), подготовка данных для ML, финансовый анализ, статистический анализ, визуализация, временные ряды, ETL-процессы.

## 2. Подключение библиотеки

`import pandas as pd`

## 3. Основные структуры данных

### 3.1 Series - одномерный массив с метками

**Series** - одномерная структура с индексами, похожая на колонку таблицы или массив с метками.

|Свойство/Метод|Описание|
|-|-|
|`.values`|Значения Series как массив NumPy|
|`.index`|Объект индекса|
|`.dtype`|Тип данных|
|`.name`|Имя Series|
|`.head(n)`|Первые n элементов|
|`.tail(n)`|Последние n элементы|
|`.unique()`|Уникальные значения|
|`.value_counts()`|Частота значений|

**Создание Series:**

|Метод|Описание|
|-|-|
|`pd.Series(data)`|Из списка, массива, словаря|
|`pd.Series(data, index=labels)`|С явным указанием индекса|

### 3.2 DataFrame - двумерная табличная структура

**DataFrame** - двумерная таблица с метками для строк и столбцов. Строки (ось 0) - наблюдения, столбцы (ось 1) - переменные.

**Важно**: все элементы в столбце могут быть разных типов, но обычно одного типа.

**Важно**: пропущенные значения отображаются как `NaN` или `None`.

**Важно**: индексация начинается с нуля!

|Свойство|Описание|
|-|-|
|`.shape`|Размер: (число строк, число столбцов)|
|`.index`|Индекс строк|
|`.columns`|Названия столбцов|
|`.dtypes`|Типы данных по столбцам|
|`.size`|Общее число элементов|
|`.ndim`|Число измерений (всегда 2)|
|`.T`|Транспонированный DataFrame|
|`.values`|Значения как массив NumPy|

**Создание DataFrame:**

|Метод|Описание|
|-|-|
|`pd.DataFrame(data)`|Из словаря, списка словарей, массива NumPy|
|`pd.DataFrame(data, index=labels, columns=names)`|С явным указанием индекса и столбцов|

### 3.3 Index - объект индекса

**Index** - неизменяемая структура для хранения меток осей.

|Тип индекса|Описание|
|-|-|
|`RangeIndex`|Целочисленный индекс по умолчанию (0, 1, 2, ...)|
|`Int64Index`|Целочисленный индекс с явным указанием|
|`DatetimeIndex`|Индекс для временных рядов|
|`MultiIndex`|Иерархический/многоуровневый индекс|
|`CategoricalIndex`|Индекс для категориальных данных|

|Метод|Описание|
|-|-|
|`.set_index(keys, drop=True, inplace=False)`|Установить столбец(ы) как индекс|
|`.reset_index(drop=False, inplace=False)`|Сбросить индекс в столбец|
|`pd.date_range(start, end, periods, freq)`|Создать временной индекс|
|`pd.MultiIndex.from_tuples(tuples)`|Создать многоуровневый индекс|

## 4. Загрузка и сохранение данных

### 4.1 Чтение данных

|Функция|Формат|Основные параметры|
|-|-|-|
|`pd.read_csv(filepath)`|CSV|`sep`, `decimal`, `encoding`, `header`, `index_col`, `usecols`, `nrows`, `skiprows`, `na_values`|
|`pd.read_excel(filepath)`|Excel|`sheet_name`, `header`, `index_col`, `usecols`, `engine`|
|`pd.read_json(filepath)`|JSON|`orient`, `lines`|
|`pd.read_sql(query, conn)`|SQL|`query` (SQL-запрос), `conn` (соединение с БД)|
|`pd.read_sql_query(query, conn)`|SQL|Выполнение SQL-запроса|
|`pd.read_sql_table(table_name, conn)`|SQL|Чтение всей таблицы|
|`pd.read_parquet(filepath)`|Parquet|`engine`, `columns`|
|`pd.read_hdf(filepath)`|HDF5|`key` (имя таблицы в файле)|
|`pd.read_pickle(filepath)`|Pickle|Бинарный формат Python|
|`pd.read_html(url)`|HTML|Извлечение таблиц из HTML|
|`pd.read_clipboard()`|Буфер|Чтение из буфера обмена|

### 4.2 Запись данных

|Метод|Формат|Основные параметры|
|-|-|-|
|`.to_csv(filepath)`|CSV|`sep`, `decimal`, `encoding`, `index`, `header`, `na_rep`|
|`.to_excel(filepath)`|Excel|`sheet_name`, `index`, `header`, `engine`|
|`.to_json(filepath)`|JSON|`orient`, `lines`, `force_ascii`|
|`.to_sql(table_name, conn)`|SQL|`if_exists` ('fail', 'replace', 'append'), `index`|
|`.to_parquet(filepath)`|Parquet|`engine`, `compression`|
|`.to_hdf(filepath, key)`|HDF5|`key` (имя таблицы), `mode`|
|`.to_pickle(filepath)`|Pickle|Бинарный формат Python|

## 5. Базовые операции с данными

### 5.1 Просмотр и навигация

|Метод|Описание|
|-|-|
|`.head(n=5)`|Первые n строк|
|`.tail(n=5)`|Последние n строк|
|`.sample(n=5, random_state=None)`|Случайные n строк|
|`.info()`|Информация о DataFrame (типы, пропуски, память)|
|`.describe(include=None, exclude=None)`|Описательная статистика (count, mean, std, min, 25%, 50%, 75%, max)|
|`.shape`|Размерность (строки, столбцы)|
|`.columns`|Названия столбцов|
|`.index`|Индекс строк|
|`.dtypes`|Типы данных по столбцам|
|`.size`|Общее число элементов|
|`.nunique()`|Число уникальных значений по столбцам|

### 5.2 Индексация и выбор данных

|Метод|Описание|Тип|
|-|-|-|
|`.loc[row_labels, col_labels]`|Выбор по меткам (включительно)|По меткам|
|`.iloc[row_positions, col_positions]`|Выбор по позициям (не включая конец)|По позициям|
|`df['column']`|Выбор одного столбца (Series)|Столбец|
|`df[['col1', 'col2']]`|Выбор нескольких столбцов (DataFrame)|Столбцы|
|`df[condition]`|Логическая индексация|Фильтрация|
|`.at[row_label, col_label]`|Быстрый доступ к одному значению по меткам|Скаляр|
|`.iat[row_position, col_position]`|Быстрый доступ к одному значению по позициям|Скаляр|

**Логические операторы для фильтрации:**

|Оператор|Описание|
|-|-|
|`&`|И (AND)|
|`\|`|ИЛИ (OR)|
|`~`|НЕ (NOT)|
|`.isin(values)`|Проверка на вхождение|
|`.between(left, right)`|Проверка на вхождение в диапазон|
|`.str.contains(pattern)`|Проверка на содержание подстроки|

### 5.3 Сортировка и фильтрация

|Метод|Описание|
|-|-|
|`.sort_values(by, ascending=True, inplace=False)`|Сортировка по значениям столбца(ов)|
|`.sort_index(ascending=True, inplace=False)`|Сортировка по индексу|
|`.query(expr)`|Фильтрация по строковому выражению|
|`.nlargest(n, columns)`|n наибольших значений|
|`.nsmallest(n, columns)`|n наименьших значений|

### 5.4 Работа со столбцами и строками

|Операция|Метод|Описание|
|-|-|-|
|Добавление столбца|`df['new_col'] = values`|Создать новый столбец|
|Добавление столбцов|`df[['col1', 'col2']] = values`|Создать несколько столбцов|
|Удаление столбцов|`.drop(columns=['col1', 'col2'], inplace=False)`|Удалить столбцы|
|Удаление столбца|`del df['column']`|Удалить столбец (на месте)|
|Удаление столбца|`.pop('column')`|Удалить и вернуть столбец|
|Удаление строк|`.drop(index=[0, 1, 2], inplace=False)`|Удалить строки по индексу|
|Переименование|`.rename(columns={'old': 'new'}, inplace=False)`|Переименовать столбцы/индекс|
|Переименование|`.columns = ['A', 'B', 'C']`|Присвоить новые имена столбцам|

## 6. Обработка пропущенных значений (NaN)

### 6.1 Обнаружение пропусков

|Метод|Описание|
|-|-|
|`.isnull()` или `.isna()`|Проверка на пропуски (True/False)|
|`.notnull()` или `.notna()`|Проверка на наличие значений (True/False)|
|`.isnull().sum()`|Количество пропусков по столбцам|
|`.isnull().any()`|Есть ли пропуски в столбцах|
|`.isnull().all()`|Все ли значения пропущены в столбцах|

### 6.2 Обработка пропусков

|Метод|Описание|Параметры|
|-|-|-|
|`.dropna(axis=0, how='any', inplace=False)`|Удаление строк/столбцов с пропусками|`axis` (0-строки, 1-столбцы), `how` ('any', 'all'), `subset` (список столбцов), `thresh` (минимум непропущенных)|
|`.fillna(value, method=None, inplace=False)`|Заполнение пропусков|`value` (скаляр, словарь, Series), `method` ('ffill'/'pad', 'bfill'/'backfill')|
|`.interpolate(method='linear', inplace=False)`|Интерполяция пропусков|`method` ('linear', 'time', 'polynomial', и др.)|
|`.replace(to_replace, value, inplace=False)`|Замена значений|`to_replace` (значение или список), `value` (новое значение)|

**Стратегии заполнения:**

|Стратегия|Применение|
|-|-|
|Удаление (dropna)|Если пропусков мало (< 5%)|
|Константа (fillna)|Для категориальных данных|
|Среднее/медиана (fillna)|Для числовых данных|
|Мода (fillna)|Для категориальных данных|
|Forward/backward fill|Для временных рядов|
|Интерполяция|Для временных рядов|
|По группам (groupby + transform)|Заполнение по категориям|

## 7. Преобразование и очистка данных

### 7.1 Замена значений и преобразование типов

|Метод|Описание|
|-|-|
|`.replace(to_replace, value, inplace=False)`|Замена значений|
|`.map(mapping)`|Применение словаря/функции к Series|
|`.astype(dtype)`|Изменение типа данных|
|`pd.to_numeric(series, errors='raise')`|Преобразование в числовой тип|
|`pd.to_datetime(series, format=None, errors='raise')`|Преобразование в datetime|
|`.astype('category')`|Преобразование в категориальный тип|

### 7.2 Агрегация и группировка (groupby)

|Метод|Описание|
|-|-|
|`.groupby(by)`|Группировка по столбцу(ам)|
|`.agg(func)`|Применение функции(й) агрегации|
|`.transform(func)`|Применение функции с сохранением размерности|
|`.filter(func)`|Фильтрация групп по условию|
|`.apply(func)`|Применение произвольной функции к группам|
|`.size()`|Размер каждой группы|
|`.count()`|Количество непропущенных значений в группах|

**Функции агрегации:**

|Функция|Описание|
|-|-|
|`'sum'`|Сумма|
|`'mean'`|Среднее|
|`'median'`|Медиана|
|`'min'`, `'max'`|Минимум, максимум|
|`'std'`, `'var'`|Стандартное отклонение, дисперсия|
|`'count'`|Количество|
|`'first'`, `'last'`|Первое, последнее значение|
|`'nunique'`|Количество уникальных значений|

### 7.3 Объединение датафреймов

|Функция/Метод|Описание|Параметры|
|-|-|-|
|`pd.concat([df1, df2], axis=0)`|Конкатенация (объединение)|`axis` (0-вертикально, 1-горизонтально), `ignore_index`, `keys`|
|`pd.merge(df1, df2, on='key')`|Слияние по ключу (SQL JOIN)|`on`, `left_on`, `right_on`, `how` ('inner', 'left', 'right', 'outer'), `indicator`|
|`.join(other, how='left')`|Слияние по индексу|`how`, `on`, `lsuffix`, `rsuffix`|

**Типы слияния (how):**

|Тип|Описание|
|-|-|
|`'inner'`|Только совпадающие записи|
|`'left'`|Все из левого + совпадения|
|`'right'`|Все из правого + совпадения|
|`'outer'`|Все записи из обоих|
|`'cross'`|Декартово произведение|

### 7.4 Переформирование данных

|Метод|Описание|Направление|
|-|-|-|
|`.pivot(index, columns, values)`|Создание сводной таблицы|Длинный → Широкий|
|`.pivot_table(index, columns, values, aggfunc)`|Сводная таблица с агрегацией|Длинный → Широкий|
|`.melt(id_vars, value_vars)`|Преобразование в длинный формат|Широкий → Длинный|
|`.stack(level=-1)`|Перенос столбцов в индекс|Широкий → Длинный|
|`.unstack(level=-1)`|Перенос индекса в столбцы|Длинный → Широкий|
|`.transpose()` или `.T`|Транспонирование|Столбцы ↔ Строки|

**Параметры pivot_table:**

|Параметр|Описание|
|-|-|
|`index`|Столбец(ы) для индекса|
|`columns`|Столбец(ы) для столбцов|
|`values`|Столбец(ы) для значений|
|`aggfunc`|Функция агрегации ('sum', 'mean', и др.)|
|`fill_value`|Значение для заполнения пропусков|
|`margins`|Добавить итоговые строки/столбцы|
|`margins_name`|Имя для итоговых строк/столбцов|

## 8. Вычисление и генерация новых признаков

### 8.1 Применение функций

|Метод|Описание|Применение|
|-|-|-|
|`.apply(func, axis=0)`|Применение функции к строкам/столбцам|DataFrame, Series|
|`.map(func)`|Применение функции к каждому элементу|Series|
|`.applymap(func)` (deprecated)|Применение функции к каждому элементу|DataFrame (использовать .map)|

### 8.2 Условные вычисления

|Функция|Описание|
|-|-|
|`np.where(condition, x, y)`|Условный выбор (if-else)|
|`np.select(conditions, choices, default)`|Множественный условный выбор|
|`.mask(cond, other)`|Замена значений, где условие True|
|`.where(cond, other)`|Замена значений, где условие False|

### 8.3 Категориальные преобразования

|Функция/Метод|Описание|
|-|-|
|`pd.cut(x, bins, labels)`|Биннинг - разбиение на интервалы|
|`pd.qcut(x, q, labels)`|Квантильное разбиение|
|`pd.get_dummies(data, prefix, drop_first)`|One-hot encoding (дамми-переменные)|
|`.astype('category')`|Преобразование в категориальный тип|

### 8.4 Математические и статистические операции

**Базовая статистика:**

|Метод|Описание|
|-|-|
|`.sum(axis=0, skipna=True)`|Сумма|
|`.mean(axis=0, skipna=True)`|Среднее|
|`.median(axis=0, skipna=True)`|Медиана|
|`.std(axis=0, skipna=True)`|Стандартное отклонение|
|`.var(axis=0, skipna=True)`|Дисперсия|
|`.min(axis=0, skipna=True)`|Минимум|
|`.max(axis=0, skipna=True)`|Максимум|
|`.count()`|Количество непропущенных значений|
|`.quantile(q=0.5, axis=0)`|Квантили|
|`.corr(method='pearson')`|Корреляционная матрица|
|`.cov()`|Ковариационная матрица|

**Кумулятивные операции:**

|Метод|Описание|
|-|-|
|`.cumsum(axis=0, skipna=True)`|Кумулятивная сумма|
|`.cumprod(axis=0, skipna=True)`|Кумулятивное произведение|
|`.cummin(axis=0, skipna=True)`|Кумулятивный минимум|
|`.cummax(axis=0, skipna=True)`|Кумулятивный максимум|

**Скользящие окна:**

|Метод|Описание|
|-|-|
|`.rolling(window, min_periods=None)`|Скользящее окно|
|`.expanding(min_periods=1)`|Расширяющееся окно|
|`.ewm(span=None, alpha=None)`|Экспоненциально взвешенное окно|

**После создания окна применяются:**

|Метод|Описание|
|-|-|
|`.mean()`|Среднее в окне|
|`.sum()`|Сумма в окне|
|`.std()`|Стандартное отклонение в окне|
|`.var()`|Дисперсия в окне|
|`.min()`, `.max()`|Минимум, максимум в окне|

**Ранжирование:**

|Метод|Описание|
|-|-|
|`.rank(method='average', ascending=True)`|Ранжирование значений|

Параметр `method`: `'average'`, `'min'`, `'max'`, `'first'`, `'dense'`

### 8.5 Арифметические операции

|Операция|Описание|
|-|-|
|`+`, `-`, `*`, `/`|Базовые арифметические операции|
|`**`|Возведение в степень|
|`//`|Целочисленное деление|
|`%`|Остаток от деления|
|`.add()`, `.sub()`, `.mul()`, `.div()`|Методы для арифметических операций|

## 9. Работа со строками (String methods)

Доступны через `.str` для Series:

|Метод|Описание|
|-|-|
|`.str.lower()`, `.str.upper()`|Преобразование регистра|
|`.str.capitalize()`, `.str.title()`|Капитализация|
|`.str.strip()`, `.str.lstrip()`, `.str.rstrip()`|Удаление пробелов|
|`.str.replace(pat, repl)`|Замена подстрок|
|`.str.contains(pat)`|Проверка на содержание|
|`.str.startswith(pat)`, `.str.endswith(pat)`|Проверка начала/конца|
|`.str.split(pat, expand=False)`|Разделение строк|
|`.str.join(sep)`|Объединение строк|
|`.str.extract(pat, expand=True)`|Извлечение с помощью regex|
|`.str.len()`|Длина строки|
|`.str[start:stop]`|Срезы строк|
|`.str.cat(others, sep=None)`|Конкатенация строк|

## 10. Работа с датами и временем

Доступны через `.dt` для Series с типом datetime:

|Метод/Свойство|Описание|
|-|-|
|`pd.to_datetime(arg, format=None)`|Преобразование в datetime|
|`.dt.year`, `.dt.month`, `.dt.day`|Компоненты даты|
|`.dt.hour`, `.dt.minute`, `.dt.second`|Компоненты времени|
|`.dt.dayofweek`, `.dt.weekday`|День недели (0=Monday)|
|`.dt.dayofyear`|День года|
|`.dt.quarter`|Квартал|
|`.dt.is_leap_year`|Високосный год|
|`.dt.days_in_month`|Дней в месяце|
|`.dt.date`, `.dt.time`|Дата, время|
|`.dt.strftime(format)`|Форматирование в строку|
|`pd.date_range(start, end, periods, freq)`|Создание диапазона дат|
|`pd.Timedelta(days=1)`|Временная дельта|
|`pd.DateOffset(months=1)`|Смещение даты|

**Частоты (freq) для date_range:**

|Частота|Описание|
|-|-|
|`'D'`|День|
|`'W'`|Неделя|
|`'M'`|Конец месяца|
|`'MS'`|Начало месяца|
|`'Q'`|Конец квартала|
|`'Y'`|Конец года|
|`'H'`|Час|
|`'T'` или `'min'`|Минута|
|`'S'`|Секунда|

## 11. Базовая визуализация

|Метод|Описание|Параметры|
|-|-|-|
|`.plot(kind='line', **kwargs)`|Базовая визуализация|`x`, `y`, `kind`, `title`, `xlabel`, `ylabel`, `grid`, `legend`, `figsize`, `rot`, `logx`, `logy`, `subplots`|
|`.plot.line(x, y)`|Линейный график|По умолчанию|
|`.plot.bar(x, y)`|Столбчатая диаграмма|Вертикальная|
|`.plot.barh(x, y)`|Горизонтальная столбчатая диаграмма||
|`.plot.hist(column, bins)`|Гистограмма|`bins` (число интервалов)|
|`.plot.box(column)`|Ящик с усами||
|`.plot.scatter(x, y, s, c)`|Диаграмма рассеяния|`s` (размер), `c` (цвет)|
|`.plot.area(x, y)`|График с областью||
|`.plot.pie(y)`|Круговая диаграмма||
|`.plot.hexbin(x, y, gridsize)`|Гексагональный бинплот||
|`.plot.kde()` или `.plot.density()`|График плотности||

**Типы графиков (kind):**

|Kind|Описание|
|-|-|
|`'line'`|Линейный график (по умолчанию)|
|`'bar'`|Столбчатая диаграмма|
|`'barh'`|Горизонтальная столбчатая|
|`'hist'`|Гистограмма|
|`'box'`|Ящик с усами|
|`'kde'`, `'density'`|График плотности|
|`'area'`|График с областью|
|`'pie'`|Круговая диаграмма|
|`'scatter'`|Диаграмма рассеяния|
|`'hexbin'`|Гексагональный бинплот|

## 12. Дополнительные полезные методы

|Метод|Описание|
|-|-|
|`.copy(deep=True)`|Копирование DataFrame|
|`.duplicated(subset=None, keep='first')`|Обнаружение дубликатов|
|`.drop_duplicates(subset=None, keep='first', inplace=False)`|Удаление дубликатов|
|`.unique()`|Уникальные значения (Series)|
|`.nunique()`|Количество уникальных значений|
|`.value_counts(normalize=False, dropna=True)`|Частота значений|
|`.isin(values)`|Проверка на вхождение|
|`.between(left, right, inclusive='both')`|Проверка на вхождение в диапазон|
|`.clip(lower=None, upper=None)`|Обрезка значений|
|`.abs()`|Абсолютное значение|
|`.round(decimals=0)`|Округление|
|`.diff(periods=1)`|Разность между элементами|
|`.pct_change(periods=1)`|Процентное изменение|
|`.rank(method='average', ascending=True)`|Ранжирование|
|`.memory_usage(deep=False)`|Использование памяти|

## 13. Оптимизация и производительность

|Метод/Подход|Описание|
|-|-|
|`.astype('category')`|Использование категориального типа для экономии памяти|
|Векторизация|Использование векторизованных операций вместо циклов|
|`.query()`|Более быстрая фильтрация для больших данных|
|`pd.eval()`|Быстрые вычисления для больших выражений|
|Chaining методов|`df.method1().method2().method3()`|
|`.pipe(func, *args, **kwargs)`|Применение функции в цепочке|
|`inplace=True`|Изменение на месте (экономия памяти)|

---

## Полезные ссылки

- Официальная документация: https://pandas.pydata.org/docs/
- User Guide: https://pandas.pydata.org/docs/user_guide/index.html
- API Reference: https://pandas.pydata.org/docs/reference/index.html
